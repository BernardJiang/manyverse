image: thyrlian/android-sdk

stages:
  - setup
  - install
  - build
  - test

setup_essentials:
  stage: setup
  script:
    - apt-get --quiet update --yes
    - apt-get --quiet install --yes curl gcc g++ make git

install_nodejs:
  stage: install
  script:
    - curl -sL https://deb.nodesource.com/setup_10.x | bash -
    - apt-get --quiet install --yes nodejs

install_watchman:
  stage: install
  script:
    - apt-get --quiet install --yes autoconf automake build-essential
    - apt-get --quiet install --yes python-dev libtool pkg-config libssl-dev
    - git clone https://github.com/facebook/watchman.git
    - cd watchman
    - git checkout v4.9.0
    - ./autogen.sh
    - ./configure
    - make
    - make install
    - cd ..
    - watchman --version

install_android_extras:
  stage: install
  script:
    - apt-get --quiet install --yes default-jdk default-jre
    - $ANDROID_HOME/tools/bin/sdkmanager "lldb;3.1" > /dev/null
    - $ANDROID_HOME/tools/bin/sdkmanager "cmake;3.6.4111459" > /dev/null
    - $ANDROID_HOME/tools/bin/sdkmanager "ndk-bundle" > /dev/null
    - export GRADLE_USER_HOME=$(pwd)/android/.gradle
    - export ANDROID_NDK_HOME=$ANDROID_HOME/ndk-bundle
    - chmod +x ./android/gradlew

install_project_deps:
  stage: install
  script:
    - npm install -g react-native-cli
    - npm install

build_release:
  stage: build
  script:
    - npm run build-android-release
  artifacts:
    paths:
      - android/app/build/outputs/apk/release

e2e_tests:
  stage: test
  script:
    - npm run test-e2e-android
